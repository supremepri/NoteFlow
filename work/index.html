<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NoteFlow</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css"
        integrity="sha384-X38yfunGUhNzHpBaEBsWLO+A0HDYOQi8ufWDkZ0k9e0eXz/tH3II7uKZ9msv++Ls"
        crossorigin="anonymous">
  <script src="static/app.js" type="module"></script>
  <script src="static/timer.js"></script>
  <link rel="stylesheet" href="style.css">


</head>
<body>
  <div class="app-container">
    <header>
      <h1>NoteFlow</h1>
      <nav>
        <button onclick="switchView('chat-view')">ü§ñ Chat</button>
        <button onclick="switchView('notes-view')">üìù Notes</button>
        <button onclick="switchView('learn-view')">üìö Learn</button> <!-- New button -->
        
        <button onclick="switchView('timer-view')">‚è± Timer</button>
        
      </nav>
    </header>
    <main>
      <div id="auth-section">
        <button id="google-login">Login with Google</button>
        <button id="logout-btn" style="display:none;">Logout</button>
      </div>
      <section id="chat-view">
        <div id="chat-box"></div>
        <form id="chat-form" action="javascript:void(0);">
          <input type="text" id="user-input" placeholder="Type a message..." />
          <button type="submit" class="pure-button">Send</button>
        </form>
        <button id="save-note">üìå Save Note</button>
        <button id="delete-note">‚ú®Favorite Note</button>
        <div id="loading" style="display: none;">‚è≥ Loading...</div>
      </section>

      <section id="timer-view" style="display:none;">
        <div id="timer-container">
          <h2>Timer</h2>
          <div id="timer">00:00:00</div>
          <div id="timer-controls">
            <button onclick="startTimer()" class="pure-button">Start</button>
            <button onclick="pauseTimer()" class="pure-button">Pause</button>
            <button onclick="resetTimer()" class="pure-button">Reset</button>
          </div>
        </div>
      </section>

      <div id="floating-timer" style="display: none;">
        <div id="timer">00:00:00</div>
        <button id="close-timer" onclick="hideFloatingTimer()">‚úñ</button>
      </div>
      <button onclick="showFloatingTimer()">‚è± Show Timer</button>


      <section id="notes-view" style="display:none;">
        <div id="notes-list">
          <!-- Dynamic list of notes will populate here -->
        </div>
        <div id="note-editor-container">
          <textarea id="note-editor" placeholder="Edit your note here..."></textarea>
          <input type="text" id="note-tags" placeholder="Optional tags">
          <button id="save-edit">Save Changes</button>
        </div>
      </section>
      


      <section id="learn-view" style="display:none;">
        <h2 style="text-align: center;">Learn</h2>
        <label for="topic-dropdown" style="display: block; text-align: center;">Choose a note:</label>
        <select id="topic-dropdown" style="display: block; margin: 10px auto; width: 50%; padding: 8px; border-radius: 8px;">
          <option value="" disabled selected>Select a note</option>
        </select>
        <textarea id="learn-input" placeholder="Ask a question about the selected note..."></textarea>
        <button id="ask-ai" style="display: block; margin: 15px auto; padding: 10px 20px; background-color: #163f46; color: white; border: none; border-radius: 8px; cursor: pointer;">Ask AI</button>
      
        <div id="learn-content">
          <!-- AI chat messages will appear here -->
        </div>
      </section>
      
      
      




    </main>
  </div>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCZWY3x0PUfvV_bwbgUVbJZhDBE3vfGQ0I",
      authDomain: "neurostack-fb468.firebaseapp.com",
      projectId: "neurostack-fb468",
      storageBucket: "neurostack-fb468.appspot.com",
      messagingSenderId: "912656189609",
      appId: "1:912656189609:web:f49e7778bff02c1c1141b8",
      measurementId: "G-TG4CDSS8LZ"
    };
  
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
  
    db.settings({ cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED });
  
    const loginBtn = document.getElementById('google-login');
    const logoutBtn = document.getElementById('logout-btn');
    const notesList = document.getElementById('notes-list');
    const loadingIndicator = document.getElementById('loading');
  
    let currentUser = null;
  
    // Login functionality
    loginBtn.onclick = async () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        await auth.signInWithPopup(provider);
        console.log("User signed in!");
      } catch (err) {
        alert(err.message);
      }
    };
  
    // Logout functionality
    logoutBtn.onclick = async () => {
      await auth.signOut();
      console.log("User signed out!");
    };
  
    // Load user notes dynamically
    async function loadUserNotes() {
      if (!currentUser) return;
  
      const snapshot = await db.collection("notes")
        .where("uid", "==", currentUser.uid)
        .orderBy("createdAt", "desc")
        .get();
  
      notesList.innerHTML = '';
  
      snapshot.forEach(doc => {
  const note = doc.data();
  const li = document.createElement('li');
  li.textContent = note.content.length > 50 ? note.content.slice(0, 50) + '...' : note.content;
  li.style.fontWeight = note.favorite ? 'bold' : 'normal'; // Highlight favorites

  li.onclick = () => {
    document.getElementById('note-editor').value = note.content;
    document.getElementById('note-tags').value = note.tags || '';
    document.getElementById('save-edit').dataset.id = doc.id;
    switchView('notes-view');
  };

  notesList.appendChild(li);
});

  
      populateNotesDropdown(snapshot); // Populate dropdown with user notes
    }

    // Save note functionality
    document.getElementById("save-note").onclick = async () => {
  const latestFullText = document.querySelector(".ai-response:last-of-type .full-text");
  if (!latestFullText || !latestFullText.innerText.trim()) {
    alert("No AI response to save!");
    return;
  }

  if (!currentUser) {
    alert("You need to be logged in to save notes.");
    return;
  }

  const newNote = {
    uid: currentUser.uid,
    content: latestFullText.innerText.trim(),
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  try {
    await db.collection("notes").add(newNote);
    alert("Note saved successfully!");
    loadUserNotes(); // Refresh the notes list after saving
  } catch (err) {
    console.error("Error saving note:", err);
    alert("Failed to save the note.");
  }
};

    // Save edited note functionality
    document.getElementById("save-edit").onclick = async () => {
  const noteId = document.getElementById("save-edit").dataset.id;
  const content = document.getElementById("note-editor").value.trim();
  const tags = document.getElementById("note-tags").value.trim();

  if (!noteId) {
    alert("No note selected to edit!");
    return;
  }

  if (!content) {
    alert("Note content cannot be empty!");
    return;
  }

  try {
    await db.collection("notes").doc(noteId).update({
      content,
      tags,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert("Note updated successfully!");
    loadUserNotes(); // Refresh notes list to reflect changes
  } catch (err) {
    console.error("Error updating note:", err);
    alert("Failed to save the note.");
  }
};

    // Delete note functionality
    document.getElementById("delete-note").onclick = async () => {
  const noteId = document.getElementById("save-edit").dataset.id;

  if (!noteId) {
    alert("No note selected!");
    return;
  }

  try {
    const docRef = db.collection("notes").doc(noteId);
    const docSnapshot = await docRef.get();
    if (!docSnapshot.exists) {
      alert("Note not found!");
      return;
    }

    const isFavorite = docSnapshot.data().favorite || false; // Defaults to false
    await docRef.update({ favorite: !isFavorite }); // Toggle favorite
    alert(isFavorite ? "Removed from Favorites" : "Added to Favorites");
    loadUserNotes(); // Refresh notes list
  } catch (err) {
    console.error("Error toggling favorite:", err);
    alert("Failed to toggle favorite status.");
  }
};



    // Populate dropdown for Learn View
    function populateNotesDropdown(snapshot) {
      const dropdown = document.getElementById("topic-dropdown");
      dropdown.innerHTML = '<option value="" disabled selected>Select a note</option>';
  
      snapshot.forEach(doc => {
        const note = doc.data();
        const option = document.createElement("option");
        option.value = doc.id; // Store document ID for reference
        option.textContent = note.content.slice(0, 50) + "..."; // Display preview
        dropdown.appendChild(option);
      });
    }
  
    // Handle auth state changes
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        loadUserNotes(); // Load notes and populate dropdown on login
      } else {
        currentUser = null;
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
        notesList.innerHTML = '';
      }
    });
  
    // Switch view between Chat, Notes, and Learn
    function switchView(viewId) {
  ['chat-view', 'notes-view', 'learn-view', 'timer-view'].forEach(view => {
    document.getElementById(view).style.display = (view === viewId) ? 'block' : 'none';
  });
}

const floatingTimer = document.getElementById('floating-timer');

l

floatingTimer.addEventListener('mousedown', (e) => {
  isDragging = true;
  offsetX = e.clientX - floatingTimer.offsetLeft;
  offsetY = e.clientY - floatingTimer.offsetTop;
});

document.addEventListener('mousemove', (e) => {
  if (isDragging) {
    floatingTimer.style.left = `${e.clientX - offsetX}px`;
    floatingTimer.style.top = `${e.clientY - offsetY}px`;
  }
});

document.addEventListener('mouseup', () => {
  isDragging = false;
});

function showFloatingTimer() {
  floatingTimer.style.display = 'block';
}

function hideFloatingTimer() {
  floatingTimer.style.display = 'none';
}


    // Ask AI functionality
    async function sendQuery() {
  const question = document.getElementById("user-input").value.trim();
  if (!question) return alert("Cannot send an empty message!");

  // Show loading indicator
  loadingIndicator.style.display = "block";

  try {
    const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": "Bearer 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",
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: "meta-llama/llama-3.3-70b-instruct:free",
        messages: [
          { role: "system", content: "You are a helpful assistant., whenever explaining content use proper spacing which is efficient and helps the user read better and DO NOT USE ASTERISK  AT ANY POINT IN EXPLAINATION RATHER USE ‚Ä¢, and for titles use underlines _______ " },
          { role: "user", content: question }
        ]
      })
    });

    if (!res.ok) {
      console.error("Error fetching response. Status:", res.status);
      alert("Failed to get response from AI.");
      return;
    }

    const data = await res.json();
    const reply = data.choices?.[0]?.message?.content || "ü§ñ No response.";

    // Parse AI response
    const lines = reply.split('\n').filter(line => line.trim() !== "");
    const previewLines = lines.slice(0, 2).join('<br>');
    const fullLines = lines.join('<br>');

    // Create response container
    const responseContainer = document.createElement('div');
    responseContainer.classList.add('ai-response');

    // Create preview and full-text spans
    const previewSpan = document.createElement('span');
    previewSpan.className = 'preview-text';
    previewSpan.innerHTML = previewLines;

    const fullSpan = document.createElement('span');
    fullSpan.className = 'full-text hidden';
    fullSpan.innerHTML = fullLines;

    // Create toggle button
    const toggleBtn = document.createElement('button');
    toggleBtn.textContent = 'Show More';
    toggleBtn.onclick = () => {
      fullSpan.classList.toggle('hidden');
      previewSpan.classList.toggle('hidden');
      toggleBtn.textContent = toggleBtn.textContent === 'Show More' ? 'Show Less' : 'Show More';
    };

    // Append elements to response container
    responseContainer.append(previewSpan, fullSpan, toggleBtn);

    // Append response container to chat-box
    document.getElementById("chat-box").appendChild(responseContainer);

    console.log("AI Response:", reply);
  } catch (err) {
    console.error("Error during fetch:", err.message);
    alert("Failed to get response!");
  } finally {
    // Hide loading indicator
    loadingIndicator.style.display = "none";
  }
}

// Event listener for chat form submission
document.getElementById("chat-form").addEventListener("submit", function (e) {
  e.preventDefault();
  sendQuery();
  document.getElementById("user-input").value = "";
});
  
    // Render chat message in Learn View
    function renderChatMessage(role, message) {
  const learnContent = document.getElementById("learn-content");
  if (!learnContent) {
    console.error("Learn-content element not found!");
    return;
  }

  // Create message container
  const messageContainer = document.createElement("div");
  messageContainer.classList.add("chat-message", role);

  // Add message text
  const text = document.createElement("p");
  text.textContent = message;

  // Append everything to the container
  messageContainer.appendChild(text);
  learnContent.appendChild(messageContainer);

  // Auto-scroll to the latest message
  learnContent.scrollTop = learnContent.scrollHeight;

  console.log(`Message rendered (${role}):`, message);
}

document.getElementById("ask-ai").onclick = async () => {
  const dropdown = document.getElementById("topic-dropdown");
  const noteId = dropdown.value;
  const userQuery = document.getElementById("learn-input").value.trim();

  if (!noteId) return alert("Please select a note first!");
  if (!userQuery) return alert("Please ask a question!");

  const docRef = db.collection("notes").doc(noteId);
  const docSnapshot = await docRef.get();
  if (!docSnapshot.exists) return alert("Note not found!");

  const noteContent = docSnapshot.data().content;
  const context = `User note: ${noteContent}\n\nUser question: ${userQuery}`;

  // Show loading indicator
  loadingIndicator.style.display = "block";

  try {
    const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        Authorization: "Bearer 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",
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: "meta-llama/llama-3.3-70b-instruct:free",
        messages: [
          { role: "system", content: "Analyze the following note and answer the user's question based on it.DO NOT USE ASTERISK  AT ANY POINT IN EXPLAINATION RATHER USE ‚Ä¢, and for titles use underlines _______  " },
          { role: "user", content: context }
        ]
      })
    });

    const data = await res.json();
    const reply = data.choices?.[0]?.message?.content || "ü§ñ No response.";

    renderChatMessage("user", userQuery); // Display user query
    renderChatMessage("assistant", reply); // Display AI response
  } catch (err) {
    console.error("Error during fetch:", err.message);
    alert("Failed to get response!");
  } finally {
    // Hide loading indicator
    loadingIndicator.style.display = "none";
  }
};


  </script>
  
  